# Offline Functionality - Architecture Diagram

## System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         USER INTERFACE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ OfflineBanner│  │ SyncStatus   │  │ Cached       │        │
│  │              │  │ Indicator    │  │ Badge        │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Offline      │  │ Disabled     │  │ Requires     │        │
│  │ Error Widget │  │ Button       │  │ Internet     │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                           SCREENS                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │ Manage       │  │ Queue        │  │ Sync         │        │
│  │ Downloads    │  │ Screen       │  │ Conflict     │        │
│  └──────────────┘  └──────────────┘  └──────────────┘        │
│                                                                 │
│  ┌──────────────┐                                              │
│  │ Offline      │                                              │
│  │ Storage      │                                              │
│  │ Settings     │                                              │
│  └──────────────┘                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      STATE MANAGEMENT                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────┐          │
│  │           Provider (ChangeNotifier)              │          │
│  │                                                  │          │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐│          │
│  │  │Connectivity│  │   Queue    │  │   Sync     ││          │
│  │  │  Service   │  │  Manager   │  │  Provider  ││          │
│  │  └────────────┘  └────────────┘  └────────────┘│          │
│  │         │               │               │       │          │
│  │         └───────────────┴───────────────┘       │          │
│  │                     │                           │          │
│  └─────────────────────┼───────────────────────────┘          │
│                        │                                       │
└────────────────────────┼───────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                      BUSINESS LOGIC                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────┐          │
│  │              Cache Manager                       │          │
│  │  ┌────────────────────────────────────────────┐ │          │
│  │  │ • cacheData()                              │ │          │
│  │  │ • getCachedData()                          │ │          │
│  │  │ • isCacheValid()                           │ │          │
│  │  │ • clearCache()                             │ │          │
│  │  │ • cleanExpiredCache()                      │ │          │
│  │  └────────────────────────────────────────────┘ │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       DATA MODELS                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐                   │
│  │ OfflineAction    │  │ DownloadedContent│                   │
│  │ ┌──────────────┐ │  │ ┌──────────────┐ │                   │
│  │ │ id           │ │  │ │ id           │ │                   │
│  │ │ actionType   │ │  │ │ contentType  │ │                   │
│  │ │ payload      │ │  │ │ contentId    │ │                   │
│  │ │ timestamp    │ │  │ │ filePath     │ │                   │
│  │ │ retryCount   │ │  │ │ fileSize     │ │                   │
│  │ │ status       │ │  │ │ downloadedAt │ │                   │
│  │ └──────────────┘ │  │ └──────────────┘ │                   │
│  └──────────────────┘  └──────────────────┘                   │
│                                                                 │
│  ┌──────────────────┐                                          │
│  │ CachedData       │                                          │
│  │ ┌──────────────┐ │                                          │
│  │ │ key          │ │                                          │
│  │ │ data         │ │                                          │
│  │ │ cachedAt     │ │                                          │
│  │ │ expiresAt    │ │                                          │
│  │ └──────────────┘ │                                          │
│  └──────────────────┘                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      DATA PERSISTENCE                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────┐          │
│  │         SharedPreferences                        │          │
│  │  ┌────────────────────────────────────────────┐ │          │
│  │  │ • cache_*           (Cached data)          │ │          │
│  │  │ • cache_index       (Cache index)          │ │          │
│  │  │ • offline_queue     (Action queue)         │ │          │
│  │  │ • downloaded_content (Downloads)           │ │          │
│  │  │ • last_sync_time    (Last sync)            │ │          │
│  │  │ • app_settings      (Settings)             │ │          │
│  │  └────────────────────────────────────────────┘ │          │
│  └──────────────────────────────────────────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Data Flow Diagrams

### 1. Offline Action Flow

```
┌──────────┐
│   User   │
│  Action  │
└────┬─────┘
     │
     ▼
┌─────────────────┐
│ Check           │
│ Connectivity    │
└────┬────────────┘
     │
     ├─── Online ───────────────────┐
     │                              │
     │                              ▼
     │                    ┌──────────────────┐
     │                    │ Execute API Call │
     │                    └────┬─────────────┘
     │                         │
     │                         ▼
     │                    ┌──────────────────┐
     │                    │   Update UI      │
     │                    └──────────────────┘
     │
     └─── Offline ─────────────────┐
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ Create           │
                          │ OfflineAction    │
                          └────┬─────────────┘
                               │
                               ▼
                          ┌──────────────────┐
                          │ Add to Queue     │
                          └────┬─────────────┘
                               │
                               ▼
                          ┌──────────────────┐
                          │ Update UI        │
                          │ Optimistically   │
                          └────┬─────────────┘
                               │
                               ▼
                          ┌──────────────────┐
                          │ Show "Queued"    │
                          │ Feedback         │
                          └──────────────────┘
```

### 2. Sync Flow

```
┌──────────────┐
│ Connection   │
│ Restored     │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ Get Pending      │
│ Actions          │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ For Each Action  │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Process Action   │
└──────┬───────────┘
       │
       ├─── Success ──────────────┐
       │                          │
       │                          ▼
       │                 ┌──────────────────┐
       │                 │ Mark as Success  │
       │                 └────┬─────────────┘
       │                      │
       │                      ▼
       │                 ┌──────────────────┐
       │                 │ Remove from      │
       │                 │ Queue            │
       │                 └────┬─────────────┘
       │                      │
       │                      ▼
       │                 ┌──────────────────┐
       │                 │ Update UI        │
       │                 └──────────────────┘
       │
       └─── Failure ──────────────┐
                                  │
                                  ▼
                         ┌──────────────────┐
                         │ Increment Retry  │
                         │ Count            │
                         └────┬─────────────┘
                              │
                              ▼
                         ┌──────────────────┐
                         │ Retry < 3?       │
                         └────┬─────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                  Yes                  No
                    │                   │
                    ▼                   ▼
           ┌──────────────┐    ┌──────────────┐
           │ Keep Pending │    │ Mark Failed  │
           └──────────────┘    └──────────────┘
```

### 3. Cache Flow

```
┌──────────────┐
│ Request Data │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ Check Cache      │
└──────┬───────────┘
       │
       ├─── Cache Valid ──────────┐
       │                          │
       │                          ▼
       │                 ┌──────────────────┐
       │                 │ Return Cached    │
       │                 │ Data             │
       │                 └────┬─────────────┘
       │                      │
       │                      ▼
       │                 ┌──────────────────┐
       │                 │ Show "Cached"    │
       │                 │ Badge            │
       │                 └────┬─────────────┘
       │                      │
       │                      ▼
       │                 ┌──────────────────┐
       │                 │ If Online:       │
       │                 │ Fetch Fresh in   │
       │                 │ Background       │
       │                 └──────────────────┘
       │
       └─── Cache Invalid/Missing ──┐
                                    │
                                    ▼
                           ┌──────────────────┐
                           │ Check Online     │
                           └────┬─────────────┘
                                │
                      ┌─────────┴─────────┐
                      │                   │
                   Online              Offline
                      │                   │
                      ▼                   ▼
             ┌──────────────┐    ┌──────────────┐
             │ Fetch from   │    │ Show Error   │
             │ Server       │    │ "No Data"    │
             └──────┬───────┘    └──────────────┘
                    │
                    ▼
             ┌──────────────┐
             │ Update Cache │
             └──────┬───────┘
                    │
                    ▼
             ┌──────────────┐
             │ Return Data  │
             └──────────────┘
```

### 4. Conflict Resolution Flow

```
┌──────────────┐
│ Sync Action  │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ Fetch Server     │
│ Data             │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Compare with     │
│ Local Data       │
└──────┬───────────┘
       │
       ├─── No Conflict ──────────┐
       │                          │
       │                          ▼
       │                 ┌──────────────────┐
       │                 │ Apply Local      │
       │                 │ Changes          │
       │                 └────┬─────────────┘
       │                      │
       │                      ▼
       │                 ┌──────────────────┐
       │                 │ Sync Complete    │
       │                 └──────────────────┘
       │
       └─── Conflict Detected ────┐
                                  │
                                  ▼
                         ┌──────────────────┐
                         │ Show Conflict    │
                         │ Resolution       │
                         │ Screen           │
                         └────┬─────────────┘
                              │
                              ▼
                         ┌──────────────────┐
                         │ User Selects     │
                         │ Resolution       │
                         └────┬─────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
              Keep Server         Keep Local
                    │                   │
                    ▼                   ▼
           ┌──────────────┐    ┌──────────────┐
           │ Use Server   │    │ Use Local    │
           │ Data         │    │ Data         │
           └──────┬───────┘    └──────┬───────┘
                  │                   │
                  └─────────┬─────────┘
                            │
                            ▼
                   ┌──────────────────┐
                   │ Apply Resolution │
                   └────┬─────────────┘
                        │
                        ▼
                   ┌──────────────────┐
                   │ Sync to Server   │
                   └────┬─────────────┘
                        │
                        ▼
                   ┌──────────────────┐
                   │ Update UI        │
                   └──────────────────┘
```

## Component Relationships

```
┌─────────────────────────────────────────────────────────────┐
│                      Main App                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                  OfflineBanner                        │ │
│  │  ┌─────────────────────────────────────────────────┐ │ │
│  │  │              MaterialApp                        │ │ │
│  │  │  ┌───────────────────────────────────────────┐ │ │ │
│  │  │  │           Scaffold                        │ │ │ │
│  │  │  │  ┌─────────────────────────────────────┐ │ │ │ │
│  │  │  │  │         AppBar                      │ │ │ │ │
│  │  │  │  │  ┌───────────────────────────────┐ │ │ │ │ │
│  │  │  │  │  │  SyncStatusIndicator         │ │ │ │ │ │
│  │  │  │  │  └───────────────────────────────┘ │ │ │ │ │
│  │  │  │  └─────────────────────────────────────┘ │ │ │ │
│  │  │  │  ┌─────────────────────────────────────┐ │ │ │ │
│  │  │  │  │         Body                        │ │ │ │ │
│  │  │  │  │  ┌───────────────────────────────┐ │ │ │ │ │
│  │  │  │  │  │  Screen Content              │ │ │ │ │ │
│  │  │  │  │  │  • CachedBadge               │ │ │ │ │ │
│  │  │  │  │  │  • OfflineDisabledButton     │ │ │ │ │ │
│  │  │  │  │  │  • OfflineErrorWidget        │ │ │ │ │ │
│  │  │  │  │  └───────────────────────────────┘ │ │ │ │ │
│  │  │  │  └─────────────────────────────────────┘ │ │ │ │
│  │  │  └───────────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Listens to
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    Provider Tree                            │
│                                                             │
│  ConnectivityService ──┐                                   │
│                        │                                   │
│  QueueManager ─────────┼──► SyncProvider                   │
│                        │                                   │
│  SettingsProvider ─────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Uses
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   CacheManager                              │
│                   (Static Methods)                          │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ Stores in
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                SharedPreferences                            │
│                (Device Storage)                             │
└─────────────────────────────────────────────────────────────┘
```

## State Transitions

### Connectivity States

```
        ┌─────────┐
        │ Unknown │
        └────┬────┘
             │
             ▼
        ┌─────────┐
   ┌────│ Online  │────┐
   │    └─────────┘    │
   │                   │
   │ Disconnect    Connect
   │                   │
   ▼                   ▼
┌─────────┐       ┌─────────┐
│ Offline │       │ Online  │
└────┬────┘       └────┬────┘
     │                 │
     │ Connect         │ Disconnect
     │                 │
     └────────┬────────┘
              │
              ▼
        ┌─────────────┐
        │ Just Came   │
        │ Online      │
        │ (2 seconds) │
        └─────────────┘
```

### Action States

```
┌─────────┐
│ Created │
└────┬────┘
     │
     ▼
┌─────────┐
│ Pending │◄──────┐
└────┬────┘       │
     │            │
     │ Sync       │ Retry
     │            │ (< 3)
     ▼            │
┌────────────┐    │
│ Processing │────┘
└─────┬──────┘
      │
      ├─── Success ───► ┌─────────┐
      │                 │ Success │
      │                 └─────────┘
      │
      └─── Failure ───► ┌─────────┐
                        │ Failed  │
                        └─────────┘
```

### Cache States

```
┌─────────┐
│ Empty   │
└────┬────┘
     │
     │ Cache Data
     │
     ▼
┌─────────┐
│ Valid   │
└────┬────┘
     │
     │ Time Passes
     │
     ▼
┌─────────┐
│ Expired │
└────┬────┘
     │
     │ Clean/Clear
     │
     ▼
┌─────────┐
│ Empty   │
└─────────┘
```

## Integration Points

```
┌──────────────────────────────────────────────────────────┐
│                    Existing App                          │
│                                                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐       │
│  │ Wishlist   │  │ Reviews    │  │ Profile    │       │
│  │ Provider   │  │ Provider   │  │ Provider   │       │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘       │
│        │               │               │               │
│        └───────────────┴───────────────┘               │
│                        │                               │
│                        │ Integrates with               │
│                        ▼                               │
│  ┌──────────────────────────────────────────────────┐ │
│  │         Offline Functionality                    │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐ │ │
│  │  │Connectivity│  │   Queue    │  │   Sync     │ │ │
│  │  │  Service   │  │  Manager   │  │  Provider  │ │ │
│  │  └────────────┘  └────────────┘  └────────────┘ │ │
│  └──────────────────────────────────────────────────┘ │
│                                                        │
└────────────────────────────────────────────────────────┘
```

---

**Note**: These diagrams provide a visual representation of the offline functionality architecture. Refer to the implementation files for actual code.

**Version**: 1.0.0
**Last Updated**: November 14, 2024
